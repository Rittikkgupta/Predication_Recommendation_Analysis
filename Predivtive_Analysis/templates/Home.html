<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation Analysis</title>
    <style>
        .container {
            width: 80%;
            margin: 0 auto;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: rgb(186, 176, 176);
        }

        .card {
            width: 130px;
            height: 140px;
            margin: 10px;
            padding: 10px;
            box-sizing: border-box;
            float: left;
            border: 2px solid black;
            color: white;
        }

        .card1 {
            background: #c11414;
        }

        .table-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            clear: both;
            border: 2px solid black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .search-box {
            width: 80%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .Add-button {
            padding: 8px;
            margin-left: 110px;
            display: inline-block;
        }

        .pagination {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }

        .pagination button {
            margin-right: 5px;
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f2f2f2;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card">Total Scenario 9</div>
        <div class="card">Total Attribute 25</div>
        <div class="card">Active Scenario 7</div>
        <div class="card">Active Attribute 21</div>

        <div class="table-container" id="Attribute-list">
            <div class="box-container">
                <h2>Attribute</h2>
                <input type="text" class="search-box" placeholder="Search...">
                <button class="Add-button" onclick="openDbConnectPage()">Add</button>
            </div>
            <table name="Attribute List">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Attribute</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="attributeTableBody">
                    <!-- Attribute data will be populated here -->
                </tbody>
            </table>
            <div class="pagination">
                <button id="prevAttribute">Previous</button>
                <button id="nextAttribute">Next</button>
            </div>
        </div>

        <div class="table-container" id="Scenario-list">
            <div class="box-container">
                <h2>Scenario</h2>
                <input type="text" class="search-box" placeholder="Search...">
                <button class="Add-button" onclick="openDbConnectPage()">Add</button>
            </div>
            <table name="Scenario List">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Formula</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="scenarioTableBody">
                    <!-- Scenario data will be populated here -->
                </tbody>
            </table>
            <div class="pagination">
                <button id="prevScenario">Previous</button>
                <button id="nextScenario">Next</button>
            </div>
        </div>

        <div class="table-container" id="Recommendation-list">
            <div class="box-container">
                <h2>Recommendation</h2>
                <input type="text" class="search-box" placeholder="Search...">
                <button class="Add-button" onclick="openDbConnectPage()">Add</button>
            </div>
            <table name="Recommendation List">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Recommendation</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recommendationTableBody">
                    <!-- Recommendation data will be populated here -->
                </tbody>
            </table>
            <div class="pagination">
                <button id="prevRecommendation">Previous</button>
                <button id="nextRecommendation">Next</button>
            </div>
        </div>
    </div>

    <script>
        // Variables to track current page and total pages
        let currentPageAttribute = 1;
        let currentPageScenario = 1;
        let currentPageRecommendation = 1;

        // Function to make a POST request and populate tables
        function fetchDataAndPopulateTables() {
            // Make a POST request to the API endpoint
            fetch('http://127.0.0.1:8000/Home_page/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
                .then(response => response.json())
                .then(data => {
                    // Populate attribute table
                    populateTable(data.Attribute, "attributeTableBody", currentPageAttribute, "Attribute_status_Update");
                    // Populate scenario table
                    populateTable(data.Formula, "scenarioTableBody", currentPageScenario, "Formula_status_Update");
                    // Populate recommendation table
                    populateTable(data.Recommendation, "recommendationTableBody", currentPageRecommendation, "Recommendation_status_Update");
                    // Attach event listeners to "Edit" buttons
                    attachEditButtonListeners();
                })
                .catch(error => console.error('Error:', error));
        }

        // Function to populate tables with data
        function populateTable(data, tableId, currentPage, apiEndpoint) {
            const tableBody = document.getElementById(tableId);
            if (tableBody) {
                tableBody.innerHTML = ""; // Clear existing content
                const startIndex = (currentPage - 1) * 5;
                const endIndex = Math.min(startIndex + 5, data.length);
                for (let i = startIndex; i < endIndex; i++) {
                    const item = data[i];
                    const row = document.createElement("tr");
                    row.innerHTML = `
                <td>${item.ID}</td>
                <td>${item.column_name || item.Formula || item.recommendation}</td>
                <td>${item.description}</td>
                <td><button class="statusButton" data-id="${item.ID}" data-api="${apiEndpoint}">${item.status}</button></td>
                <td><button class="editButton" data-id="${item.ID}" data-description="${item.description}" data-api="${apiEndpoint}">Edit</button></td>
            `;
                    tableBody.appendChild(row);
                    // Add event listener to each status button
                    const statusButton = row.querySelector('.statusButton');
                    statusButton.addEventListener('click', () => updateStatus(statusButton.getAttribute('data-id'), statusButton.getAttribute('data-api')));
                }
            }
        }

        // Function to send a POST request to update status
        function updateStatus(id, apiEndpoint) {
            fetch(`http://127.0.0.1:8000/${apiEndpoint}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "ID": id
                })
            })
                .then(response => {
                    if (response.ok) {
                        alert('Status updated successfully');
                        fetchDataAndPopulateTables(); // Refresh data
                    } else {
                        alert('Failed to update status');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Event listeners for pagination buttons
        document.getElementById('prevAttribute').addEventListener('click', () => {
            if (currentPageAttribute > 1) {
                currentPageAttribute--;
                fetchDataAndPopulateTables();
            }
        });

        document.getElementById('nextAttribute').addEventListener('click', () => {
            currentPageAttribute++;
            fetchDataAndPopulateTables();
        });

        document.getElementById('prevScenario').addEventListener('click', () => {
            if (currentPageScenario > 1) {
                currentPageScenario--;
                fetchDataAndPopulateTables();
            }
        });

        document.getElementById('nextScenario').addEventListener('click', () => {
            currentPageScenario++;
            fetchDataAndPopulateTables();
        });

        document.getElementById('prevRecommendation').addEventListener('click', () => {
            if (currentPageRecommendation > 1) {
                currentPageRecommendation--;
                fetchDataAndPopulateTables();
            }
        });

        document.getElementById('nextRecommendation').addEventListener('click', () => {
            currentPageRecommendation++;
            fetchDataAndPopulateTables();
        });

        // Function to open the mini window for editing description
        function openEditDescriptionWindow(id, currentDescription, apiEndpoint) {
            const newDescription = prompt("Edit Description:", currentDescription);
            if (newDescription !== null && newDescription !== currentDescription) { // Check if user clicked Cancel or didn't change the description
                updateDescription(id, apiEndpoint, newDescription);
            }
        }

        // Function to update description via API
        function updateDescription(id, apiEndpoint, newDescription) {
            let updateApiEndpoint = '';
            console.log("newDescription", newDescription)
            if (apiEndpoint === 'Attribute_status_Update') {
                updateApiEndpoint = 'http://127.0.0.1:8000/Attribute_Description_update/';
            } else if (apiEndpoint === 'Formula_status_Update') {
                updateApiEndpoint = 'http://127.0.0.1:8000/Formula_Description_update/';
            } else if (apiEndpoint === 'Recommendation_status_Update') {
                updateApiEndpoint = 'http://127.0.0.1:8000/Recommendation_Description_update/';
            }

            fetch(updateApiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "ID": id,
                    "Description": newDescription
                })
            })
                .then(response => {
                    if (response.ok) {
                        alert('Description updated successfully');
                        fetchDataAndPopulateTables(); // Refresh data
                    } else {
                        alert('Failed to update description');
                    }
                })
                .catch(error => console.error('Error:', error));
        }


        // Function to attach event listeners to "Edit" buttons
        function attachEditButtonListeners() {
            const editButtons = document.querySelectorAll('.editButton');
            editButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const currentDescription = button.getAttribute('data-description');
                    const apiEndpoint = button.getAttribute('data-api');
                    openEditDescriptionWindow(id, currentDescription, apiEndpoint);
                });
            });
        }

        // Call the function to fetch data and populate tables when the page loads
        window.onload = fetchDataAndPopulateTables;

        // Function to open dbconnect.html page
        function openDbConnectPage() {
            window.location.href = "dbconnect.html";
        }
    </script>
</body>

</html>